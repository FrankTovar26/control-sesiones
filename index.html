<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sesiones Cloud Pro - Frank Tovar</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-auth-compat.js"></script>

    <style>
        :root {
            --primary: #2563eb; --secondary: #64748b; --success: #16a34a;
            --warning: #f59e0b; --danger: #dc2626; --dark: #1e293b; --bg: #f1f5f9;
        }

        body { font-family: 'Inter', sans-serif; background-color: var(--bg); margin: 0; padding: 10px; color: var(--dark); }
        #login-screen { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; text-align: center; background: white; }
        .btn-google { background: white; color: #444; padding: 12px 24px; border-radius: 8px; border: 1px solid #ddd; font-weight: bold; cursor: pointer; display: flex; align-items: center; gap: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        
        .container { max-width: 1200px; margin: auto; display: none; }
        header { background: white; padding: 15px; border-radius: 12px; margin-bottom: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }
        
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; background: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; border: 1px solid #e2e8f0; }
        .field-group { display: flex; flex-direction: column; gap: 5px; }
        label { font-weight: 600; font-size: 0.8rem; color: var(--secondary); }
        input, select { padding: 10px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: 1rem; }

        .btn-save { background: var(--primary); color: white; padding: 12px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; }
        .btn-cancel { background: var(--secondary); color: white; padding: 12px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; display: none; }
        
        .stats { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .stat-card { background: white; padding: 12px; border-radius: 12px; text-align: center; border: 1px solid #e2e8f0; }
        .stat-card span { display: block; font-size: 1.2rem; font-weight: 800; color: var(--primary); }

        .main-grid { display: grid; grid-template-columns: 1.5fr 1fr; gap: 20px; }
        .card { background: white; padding: 15px; border-radius: 12px; border: 1px solid #e2e8f0; margin-bottom: 15px; }
        
        table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        th { text-align: left; padding: 8px; border-bottom: 2px solid #f1f5f9; color: var(--secondary); text-transform: uppercase; font-size: 0.7rem; }
        td { padding: 10px 8px; border-bottom: 1px solid #f8fafc; }

        .money-blur { filter: blur(8px); opacity: 0.4; user-select: none; }
        .badge { background: #e2e8f0; padding: 2px 6px; border-radius: 6px; font-weight: bold; font-size: 0.75rem; }
        
        .actions { display: flex; gap: 5px; }
        .btn-act { border: none; padding: 6px; border-radius: 6px; cursor: pointer; font-size: 0.9rem; }
        .btn-edit { background: #dcfce7; color: var(--success); }
        .btn-copy { background: #fef3c7; color: var(--warning); }
        .btn-del { background: #fee2e2; color: var(--danger); }

        @media (max-width: 850px) {
            .main-grid { grid-template-columns: 1fr; }
            .hide-mobile { display: none; }
        }
    </style>
</head>
<body>

<div id="login-screen">
    <h1 style="color: var(--primary)">Control de Sesiones Pro</h1>
    <p>Acceso Privado - Frank Tovar</p>
    <button class="btn-google" onclick="login()">
        <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" width="20">
        Ingresar con Google
    </button>
</div>

<div class="container" id="app-container">
    <header>
        <div>
            <h1>Sesiones Cloud V2</h1>
            <button onclick="togglePrivacidad()" id="btnLock" style="background:none; border:1px solid #ddd; padding:5px 10px; border-radius:8px; cursor:pointer; margin-top:5px;">üîí Ver Montos</button>
        </div>
        <div style="text-align: right;">
            <div id="user-display" style="font-size: 0.7rem; font-weight: bold; color: var(--success);"></div>
            <button onclick="logout()" style="border:none; background:none; color:var(--danger); font-size:0.7rem; cursor:pointer;">Cerrar Sesi√≥n</button>
        </div>
    </header>

    <div class="stats">
        <div class="stat-card"><small>SESIONES</small><span id="totalSesiones">0</span></div>
        <div class="stat-card"><small>INGRESOS</small><span id="totalIngresos" class="money-blur">S/ ****</span></div>
    </div>

    <div class="form-grid">
        <input type="hidden" id="editId">
        <div class="field-group"><label>Curso</label><input list="cursos-list" id="curso"><datalist id="cursos-list"></datalist></div>
        <div class="field-group"><label>Fecha</label><input type="date" id="fecha"></div>
        <div class="field-group"><label>Horario</label>
            <select id="horario">
                <option value="09:00 - 10:40">09:00 - 10:40</option>
                <option value="11:00 - 12:40">11:00 - 12:40</option>
                <option value="14:40 - 16:40">14:40 - 16:40</option>
                <option value="16:40 - 19:00">16:40 - 19:00</option>
                <option value="19:00 - 21:00">19:00 - 21:00</option>
            </select>
        </div>
        <div class="field-group"><label>Rol</label><select id="rol"><option value="40">Titular</option><option value="30">Auxiliar</option></select></div>
        <div style="display: flex; gap: 8px;">
            <button class="btn-save" onclick="guardarSesion()" id="btnPrincipal" style="flex:2">Registrar</button>
            <button class="btn-cancel" onclick="resetForm()" id="btnCancel" style="flex:1">X</button>
        </div>
    </div>

    <div class="main-grid">
        <div class="card">
            <h3>Historial de Clases</h3>
            <table>
                <thead><tr><th>Fecha</th><th>Curso</th><th class="hide-mobile">Monto</th><th>Acciones</th></tr></thead>
                <tbody id="tablaBody"></tbody>
            </table>
        </div>
        <div class="sidebar">
            <div class="card">
                <h3>Resumen Mensual</h3>
                <table id="tablaMeses"><thead><tr><th>Mes</th><th>Ses.</th><th>Total</th></tr></thead><tbody></tbody></table>
            </div>
            <div class="card">
                <h3>Resumen Semanal</h3>
                <table id="tablaSemanas"><thead><tr><th>Rango</th><th>Ses.</th><th>Total</th></tr></thead><tbody></tbody></table>
            </div>
        </div>
    </div>
</div>

<script>
    const firebaseConfig = {
      apiKey: "AIzaSyAirJkl3GuwTRKhpOHHTMDSrQMErtVYTQA",
      authDomain: "control-de-sesiones-276d7.firebaseapp.com",
      databaseURL: "https://control-de-sesiones-276d7-default-rtdb.firebaseio.com",
      projectId: "control-de-sesiones-276d7",
      storageBucket: "control-de-sesiones-276d7.firebasestorage.app",
      messagingSenderId: "140827652455",
      appId: "1:140827652455:web:cddc90a65b71e634a67fc2",
      measurementId: "G-N58PJ9KZV7"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const auth = firebase.auth();
    const provider = new firebase.auth.GoogleAuthProvider();

    const EMAIL_AUTORIZADO = "frank.tovar@comsatelglobal.com";
    let sesiones = [];
    let mostrarMontos = false;

    auth.onAuthStateChanged(user => {
        if (user && user.email === EMAIL_AUTORIZADO) {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('app-container').style.display = 'block';
            document.getElementById('user-display').innerText = user.displayName;
            iniciarApp();
        } else if (user) {
            alert("Acceso denegado."); auth.signOut();
        } else {
            document.getElementById('login-screen').style.display = 'flex';
            document.getElementById('app-container').style.display = 'none';
        }
    });

    function login() { auth.signInWithPopup(provider); }
    function logout() { auth.signOut(); }

    function iniciarApp() {
        const cursosBase = ["Auxiliar General", "Hablar en Publico de Verdad", "MiniInfluencer", "PsicoClown", "SocialMente", "Unicos"].sort();
        document.getElementById('cursos-list').innerHTML = cursosBase.map(c => `<option value="${c}">`).join('');
        
        db.ref('sesiones').on('value', snapshot => {
            const data = snapshot.val();
            sesiones = data ? Object.keys(data).map(key => ({...data[key], fbKey: key})) : [];
            renderizar();
        });
    }

    function guardarSesion() {
        const curso = document.getElementById('curso').value;
        const fecha = document.getElementById('fecha').value;
        const horario = document.getElementById('horario').value;
        const tarifa = parseFloat(document.getElementById('rol').value);
        const editId = document.getElementById('editId').value;

        if(!curso || !fecha) return alert("Faltan datos");
        const obj = { curso: curso.trim(), fecha, horario, tarifa };

        if(editId) {
            db.ref('sesiones/' + editId).update(obj).then(() => resetForm());
        } else {
            db.ref('sesiones').push(obj).then(() => resetForm());
        }
    }

    function prepararEdicion(id) {
        const s = sesiones.find(x => x.fbKey === id);
        document.getElementById('editId').value = id;
        document.getElementById('curso').value = s.curso;
        document.getElementById('fecha').value = s.fecha;
        document.getElementById('horario').value = s.horario;
        document.getElementById('rol').value = s.tarifa;
        document.getElementById('btnPrincipal').innerText = "Actualizar";
        document.getElementById('btnCancel').style.display = "block";
        window.scrollTo(0,0);
    }

    function clonarSesion(id) {
        const s = sesiones.find(x => x.fbKey === id);
        document.getElementById('curso').value = s.curso;
        document.getElementById('horario').value = s.horario;
        document.getElementById('rol').value = s.tarifa;
        document.getElementById('fecha').value = "";
        document.getElementById('btnPrincipal').innerText = "Clonar Clase";
        document.getElementById('btnCancel').style.display = "block";
        window.scrollTo(0,0);
    }

    function resetForm() {
        document.getElementById('editId').value = "";
        document.getElementById('curso').value = "";
        document.getElementById('btnPrincipal').innerText = "Registrar";
        document.getElementById('btnCancel').style.display = "none";
    }

    function togglePrivacidad() {
        mostrarMontos = !mostrarMontos;
        document.getElementById('btnLock').innerText = mostrarMontos ? "üîì Ocultar" : "üîí Ver Montos";
        renderizar();
    }

    function getSemana(f) {
        let d = new Date(f + 'T12:00:00');
        let l = new Date(d.setDate(d.getDate() - d.getDay() + (d.getDay() === 0 ? -6 : 1)));
        let dom = new Date(l); dom.setDate(l.getDate() + 6);
        return `${l.toLocaleDateString('es-PE',{day:'2-digit',month:'2-digit'})} al ${dom.toLocaleDateString('es-PE',{day:'2-digit',month:'2-digit'})}`;
    }

    function renderizar() {
        const tBody = document.getElementById('tablaBody');
        const tM = document.querySelector('#tablaMeses tbody');
        const tS = document.querySelector('#tablaSemanas tbody');
        tBody.innerHTML = tM.innerHTML = tS.innerHTML = '';
        
        let total = 0, mesD = {}, semD = {};
        sesiones.sort((a,b) => b.fecha.localeCompare(a.fecha));

        sesiones.forEach(s => {
            total += s.tarifa;
            const mk = new Date(s.fecha+'T12:00:00').toLocaleDateString('es-PE',{month:'short',year:'2-digit'}).toUpperCase();
            const sk = getSemana(s.fecha);
            
            if(!mesD[mk]) mesD[mk] = {m:0,c:0}; mesD[mk].m += s.tarifa; mesD[mk].c++;
            if(!semD[sk]) semD[sk] = {m:0,c:0}; semD[sk].m += s.tarifa; semD[sk].c++;

            const pTxt = mostrarMontos ? `S/ ${s.tarifa}` : `S/ **`;
            tBody.innerHTML += `<tr>
                <td>${s.fecha.slice(5)}</td>
                <td><strong>${s.curso}</strong></td>
                <td class="hide-mobile ${mostrarMontos?'':'money-blur'}">${pTxt}</td>
                <td class="actions">
                    <button class="btn-act btn-copy" onclick="clonarSesion('${s.fbKey}')">üìã</button>
                    <button class="btn-act btn-edit" onclick="prepararEdicion('${s.fbKey}')">‚úèÔ∏è</button>
                    <button class="btn-act btn-del" onclick="if(confirm('¬øEliminar?')) db.ref('sesiones/'+'${s.fbKey}').remove()">üóëÔ∏è</button>
                </td>
            </tr>`;
        });

        Object.keys(mesD).forEach(k => tM.innerHTML += `<tr><td>${k}</td><td><span class="badge">${mesD[k].c}</span></td><td class="${mostrarMontos?'':'money-blur'}">S/ ${mesD[k].m}</td></tr>`);
        Object.keys(semD).forEach(k => tS.innerHTML += `<tr><td>${k}</td><td><span class="badge">${semD[k].c}</span></td><td class="${mostrarMontos?'':'money-blur'}">S/ ${semD[k].m}</td></tr>`);

        document.getElementById('totalSesiones').innerText = sesiones.length;
        document.getElementById('totalIngresos').innerText = mostrarMontos ? `S/ ${total.toFixed(2)}` : `S/ ****`;
        document.getElementById('totalIngresos').className = mostrarMontos ? '' : 'money-blur';
    }
</script>
</body>
</html>
